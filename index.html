<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
  <title>Peer2Peer Call App</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif;
      background: #121212; color: white; display: flex; flex-direction: column; align-items: center;
      min-height: 100vh; overflow: hidden;
    }
    header {
      width: 100%; padding: 20px; background-color: #1e1e1e; text-align: center;
      font-size: 1.5rem; font-weight: bold; color: #00d8ff; border-bottom: 1px solid #333;
    }
    .container { width: 100%; max-width: 500px; padding: 20px; position: relative; }
    video { width: 100%; border-radius: 12px; margin: 10px 0; background: black; }
    #localVideo { transform: scaleX(-1); position: fixed; bottom: 15px; right: 15px; width: 40%; border: 2px solid #00d8ff; z-index: 10; border-radius: 10px; cursor: grab; }
    #remoteVideo { width: 100%; display: none; }
    #videoControls {
      position: absolute; bottom: 10px; right: 10px; display: flex; gap: 8px; z-index: 15;
    }
    .icon-btn {
      background: rgba(0,0,0,0.6); border: none; color: white; font-size: 1rem;
      border-radius: 50%; padding: 8px; cursor: pointer;
    }
    .icon-btn:hover { background: rgba(0,0,0,0.8); }
    .input-group { margin: 15px 0; }
    input, button { width: 100%; padding: 12px; margin-top: 8px; border-radius: 8px; border: none; font-size: 1rem; }
    input { background-color: #1e1e1e; color: white; border: 1px solid #333; }
    button { background-color: #00d8ff; color: black; font-weight: bold; cursor: pointer; transition: 0.2s; }
    button:hover { background-color: #00c4e0; }
    .peer-info {
      background: #222; padding: 10px; border-radius: 8px; margin: 10px 0; word-break: break-all; font-size: 0.9rem;
      text-align: center; cursor: pointer;
    }
    .controls {
      display: flex; justify-content: space-between; gap: 10px; margin-top: 20px; transition: opacity 0.3s;
    }
    .controls button { flex: 1; }
    .muted-notice { text-align: center; font-size: 0.9rem; color: #ff6666; display: none; margin-top: 5px; }

    /* mobile full remote view */
    @media (max-width: 600px) {
      #remoteVideo {
        position: fixed; top: 0; left: 0; width: 100%; height: 100vh; object-fit: cover;
        border-radius: 0; z-index: 1;
      }
      .controls {
        position: fixed; bottom: 15px; width: 100%; left: 0;
        justify-content: center; gap: 15px; z-index: 20; opacity: 0;
      }
      .controls.show { opacity: 1; }
      #localVideo {
        width: 30%; border: 2px solid #00d8ff; z-index: 10;
      }
    }
  </style>
</head>
<body>

  <header>ðŸ”— Peer2Peer Call</header>
  <div class="container">
    <video id="remoteVideo" autoplay playsinline></video>
    <div id="mutedNotice" class="muted-notice">Participant muted</div>

    <div style="position:relative;">
      <video id="localVideo" autoplay muted playsinline></video>
      <div id="videoControls">
        <button id="cameraToggle" class="icon-btn">ðŸ“·</button>
        <button id="switchCam" class="icon-btn">ðŸ”„</button>
      </div>
    </div>

    <div class="input-group" id="generateSection">
      <button id="generateBtn" onclick="generateId()">Generate My ID</button>
      <div class="peer-info" id="myIdBox" style="display:none;" onclick="copyPeerId()">
        Your ID: <span id="peerIdText"></span> <br>
        <small style="color:#00d8ff;">(Tap to copy)</small>
      </div>
    </div>

    <div class="input-group" id="connectSection">
      <label for="targetId">Enter Peer ID to Call:</label>
      <input type="text" id="targetId" placeholder="e.g. abcd1234" />
      <button id="connectBtn" onclick="callPeer()">Connect</button>
    </div>

    <div class="controls" id="controlBar">
      <button id="muteBtn" onclick="toggleMute()">Mute</button>
      <button id="endBtn" onclick="endCall()">End Call</button>
    </div>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    let peer, localStream, currentCall, isMuted = false, dataConn;
    let videoTrack, facingMode = 'user';
    const peerIdText = document.getElementById('peerIdText');
    const myIdBox = document.getElementById('myIdBox');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const mutedNotice = document.getElementById('mutedNotice');
    const muteBtn = document.getElementById('muteBtn');
    const connectSection = document.getElementById('connectSection');
    const generateSection = document.getElementById('generateSection');
    const generateBtn = document.getElementById('generateBtn');
    const cameraToggle = document.getElementById('cameraToggle');
    const switchCam = document.getElementById('switchCam');
    const controlBar = document.getElementById('controlBar');

    async function initMedia() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode }, audio: true
        });
        localVideo.srcObject = localStream;
        videoTrack = localStream.getVideoTracks()[0];
      } catch (err) {
        alert("Camera/Microphone access denied.");
      }
    }

    async function generateId() {
      if (!localStream) await initMedia();
      if (!peer) {
        peer = new Peer();
        setupPeerEvents();
      }
      connectSection.style.display = 'none';
      generateBtn.style.display = 'none';
    }

    function setupPeerEvents() {
      peer.on('open', id => {
        peerIdText.textContent = id;
        myIdBox.style.display = 'block';
      });

      peer.on('call', call => {
        call.answer(localStream);
        handleIncomingCall(call);
      });

      peer.on('connection', conn => {
        dataConn = conn;
        dataConn.on('data', handleDataMessage);
      });

      peer.on('error', err => {
        console.error('Peer error:', err);
        alert('Peer error: ' + (err && err.message ? err.message : err));
      });
    }

    function handleIncomingCall(call) {
      call.on('stream', remoteStream => {
        remoteVideo.srcObject = remoteStream;
        remoteVideo.style.display = 'block';
      });
      currentCall = call;
      connectSection.style.display = 'none';
      generateBtn.style.display = 'none';
      myIdBox.style.display = 'none';
    }

    async function callPeer() {
      const targetId = document.getElementById('targetId').value.trim();
      if (!targetId) return alert("Please enter a valid ID.");
      if (!localStream) await initMedia();
      if (!peer) {
        peer = new Peer();
        setupPeerEvents();
        peer.on('open', () => makeCall(targetId));
      } else {
        makeCall(targetId);
      }
      generateBtn.style.display = 'none';
      connectSection.style.display = 'none';
    }

    function makeCall(targetId) {
      const call = peer.call(targetId, localStream);
      try {
        dataConn = peer.connect(targetId);
        dataConn.on('data', handleDataMessage);
      } catch (e) { console.warn('Data conn error', e); }
      call.on('stream', remoteStream => {
        remoteVideo.srcObject = remoteStream;
        remoteVideo.style.display = 'block';
      });
      call.on('close', () => {
        remoteVideo.srcObject = null;
        remoteVideo.style.display = 'none';
      });
      currentCall = call;
      myIdBox.style.display = 'none';
    }

    function handleDataMessage(msg) {
      mutedNotice.style.display = msg === 'MUTED' ? 'block' : 'none';
    }

    function toggleMute() {
      if (!localStream) return;
      isMuted = !isMuted;
      const audioTrack = localStream.getAudioTracks()[0];
      audioTrack.enabled = !isMuted;
      muteBtn.style.backgroundColor = isMuted ? '#ff6666' : '#00d8ff';
      muteBtn.textContent = isMuted ? 'Unmute' : 'Mute';
      if (dataConn && dataConn.open) dataConn.send(isMuted ? 'MUTED' : 'UNMUTED');
    }

    function endCall() {
      if (currentCall) { try { currentCall.close(); } catch(e){} currentCall=null; }
      if (peer) { try { peer.destroy(); } catch(e){} peer=null; }
      window.location.href = window.location.pathname;
    }

    function copyPeerId() {
      const id = peerIdText.textContent;
      if (!id) return;
      navigator.clipboard.writeText(id).then(() => {
        alert('Copied Peer ID: ' + id);
      }).catch(() => prompt('Copy your ID manually:', id));
    }

    // --- New Feature: Camera Toggle ---
    cameraToggle.onclick = () => {
      if (!videoTrack) return;
      const enabled = videoTrack.enabled = !videoTrack.enabled;
      cameraToggle.textContent = enabled ? 'ðŸ“·' : 'ðŸš«';
    };

    // --- New Feature: Switch Camera ---
    switchCam.onclick = async () => {
      facingMode = facingMode === 'user' ? 'environment' : 'user';
      if (localStream) {
        const tracks = localStream.getTracks();
        tracks.forEach(t => t.stop());
      }
      await initMedia();
      if (currentCall) {
        const sender = currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video');
        if (sender) sender.replaceTrack(localStream.getVideoTracks()[0]);
      }
    };

    // --- Make self video movable (drag to corners) ---
    let isDragging = false, offsetX, offsetY;
    localVideo.addEventListener('mousedown', e => {
      isDragging = true;
      offsetX = e.clientX - localVideo.offsetLeft;
      offsetY = e.clientY - localVideo.offsetTop;
    });
    document.addEventListener('mousemove', e => {
      if (!isDragging) return;
      localVideo.style.left = (e.clientX - offsetX) + 'px';
      localVideo.style.top = (e.clientY - offsetY) + 'px';
      localVideo.style.bottom = 'auto';
      localVideo.style.right = 'auto';
    });
    document.addEventListener('mouseup', () => isDragging = false);

    // --- Tap to show/hide controls like WhatsApp ---
    remoteVideo.addEventListener('click', () => {
      controlBar.classList.toggle('show');
    });

    initMedia();
  </script>
</body>
</html>
